const mensagem_enorme = `**Análise Realizada de Curto Prazo**

**OBSERVAÇÃO**: A https://dicascripto.com criptomoeda BTC mostra-se equilibrada, **revela** nossa inteligência artificial. Refinamentos nas alocações atuais podem desbloquear valorizações futuras, de acordo com análises de tendência. Aguarde as propostas de nossa I.A para realocações ao término desta análise.

OBSERVAÇÃO: A criptomoeda ETH mostra-se equilibrada, revela nossa inteligência artificial. Refinamentos nas alocações atuais podem desbloquear valorizações futuras, de acordo com análises de tendência. Aguarde as propostas de nossa I.A para realocações ao término desta análise.

ANÁLISE: A criptomoeda XRP **encontra-se estável**, segundo nossa inteligência **artificial**. Ajustes estratégicos nas alocações podem ser benéficos para aproveitar futuras oportunidades de crescimento, baseando-se em projeções de mercado. Explore as sugestões de realocação preparadas pela nossa I.A no encerramento desta análise.


**Análise Realizada de Médio Prazo**

    CUIDADO EXTREMO! Nossa inteligência artificial aponta a criptomoeda  como altamente valorizada, após um exame detalhado de variáveis como indicadores de mercado, popularidade em redes e análises emocionais. Vemos uma grande oportunidade para otimizar ganhos e reconsiderar estratégias de investimento. Esta análise sugere a possibilidade de redefinir o portfólio para maximizar o potencial de crescimento. Aguarde as sugestões de nossa I.A para ajustes no final deste relatório.

PRESTE ATENÇÃO! De acordo com a nossa análise de I.A, a criptomoeda ETH está em uma trajetória de crescimento estável. Agora pode ser o momento ideal para reavaliar e ajustar as posições de investimento atuais, com o objetivo de capturar ganhos e realocar para ativos com maior potencial. As recomendações para ajustes na carteira serão disponibilizadas ao concluir esta análise.

OLHAR CRÍTICO! A análise de nossa inteligência artificial sinaliza que a criptomoeda XRP vem apresentando um desempenho forte. Avaliar a redistribuição das alocações pode ser uma jogada inteligente para proteger os lucros e reinvestir em áreas com perspectivas de alta valorização. Aguarde as orientações de rebalanceamento sugeridas ao fim desta análise.


**Análise Realizada de Longo Prazo**

Extrema CAUTELA! A análise de nossa inteligência artificial, apresenta a criptomoeda  com um patamar de extrema valorização. Baseando-se em diversos dados e informações, dentre elas: Indicadores, menções em redes sociais, análise de sentimento e várias outras, nossa inteligência artificial enxerga uma possibilidade de captura de lucros e reavaliação estratégica das posições atuais para esta cripto. Esse movimento poderia trazer novas oportunidades para o portfólio, buscando oportunidades com maior margem de crescimento. Nossa I.A irá te apresentar uma possibilidade de rebalanceamento ao final desta análise.

ALERTA MÁXIMO! A avaliação feita pela nossa I.A destaca a criptomoeda  num nível de valorização surpreendente. A partir de uma ampla gama de dados, incluindo análises de mercado, menções sociais e sentimentos, identificamos um forte potencial para a realização de lucros e ajustes estratégicos nas alocações atuais. Esta pode ser uma chance de diversificar o portfólio com ativos de alto crescimento. Fique atento às recomendações de rebalanceamento ao concluir esta análise.

ANÁLISE: A criptomoeda XRP encontra-se estável, segundo nossa inteligência artificial. Ajustes estratégicos nas alocações podem ser benéficos para aproveitar futuras oportunidades de crescimento, baseando-se em projeções de mercado. Explore as sugestões de realocação preparadas pela nossa I.A no encerramento desta análise.


Estas sugestões de ajustes não constitui uma recomendação direta de investimento.


**Análise Realizada de Longo Prazo**

Extrema CAUTELA! A análise de nossa inteligência artificial, apresenta a criptomoeda  com um patamar de extrema valorização. Baseando-se em diversos dados e informações, dentre elas: Indicadores, menções em redes sociais, análise de sentimento e várias outras, nossa inteligência artificial enxerga uma possibilidade de captura de lucros e reavaliação estratégica das posições atuais para esta cripto. Esse movimento poderia trazer novas oportunidades para o portfólio, buscando oportunidades com maior margem de crescimento. Nossa I.A irá te apresentar uma possibilidade de rebalanceamento ao final desta análise.

ALERTA MÁXIMO! A avaliação feita pela nossa I.A destaca a criptomoeda  num nível de valorização surpreendente. A partir de uma ampla gama de dados, incluindo análises de mercado, menções sociais e sentimentos, identificamos um forte potencial para a realização de lucros e ajustes estratégicos nas alocações atuais. Esta pode ser uma chance de diversificar o portfólio com ativos de alto crescimento. Fique atento às recomendações de rebalanceamento ao concluir esta análise.

ANÁLISE: A criptomoeda XRP encontra-se estável, segundo nossa inteligência artificial. Ajustes estratégicos nas alocações podem ser benéficos para aproveitar futuras oportunidades de crescimento, baseando-se em projeções de mercado. Explore as sugestões de realocação preparadas pela nossa I.A no encerramento desta análise.


Estas sugestões de ajustes não constitui uma recomendação direta de investimento.


**Análise Realizada de Longo Prazo**

Extrema CAUTELA! A análise de nossa inteligência artificial, apresenta a criptomoeda  com um patamar de extrema valorização. Baseando-se em diversos dados e informações, dentre elas: Indicadores, menções em redes sociais, análise de sentimento e várias outras, nossa inteligência artificial enxerga uma possibilidade de captura de lucros e reavaliação estratégica das posições atuais para esta cripto. Esse movimento poderia trazer novas oportunidades para o portfólio, buscando oportunidades com maior margem de crescimento. Nossa I.A irá te apresentar uma possibilidade de rebalanceamento ao final desta análise.

ALERTA MÁXIMO! A avaliação feita pela nossa I.A destaca a criptomoeda  num nível de valorização surpreendente. A partir de uma ampla gama de dados, incluindo análises de mercado, menções sociais e sentimentos, identificamos um forte potencial para a realização de lucros e ajustes estratégicos nas alocações atuais. Esta pode ser uma chance de diversificar o portfólio com ativos de alto crescimento. Fique atento às recomendações de rebalanceamento ao concluir esta análise.

ANÁLISE: A criptomoeda XRP encontra-se estável, segundo nossa inteligência artificial. Ajustes estratégicos nas alocações podem ser benéficos para aproveitar futuras oportunidades de crescimento, baseando-se em projeções de mercado. Explore as sugestões de realocação preparadas pela nossa I.A no encerramento desta análise.


Estas sugestões de ajustes não constitui uma recomendação direta de investimento.

**Análise Realizada de Longo Prazo**

Extrema CAUTELA! A análise de nossa inteligência artificial, apresenta a criptomoeda  com um patamar de extrema valorização. Baseando-se em diversos dados e informações, dentre elas: Indicadores, menções em redes sociais, análise de sentimento e várias outras, nossa inteligência artificial enxerga uma possibilidade de captura de lucros e reavaliação estratégica das posições atuais para esta cripto. Esse movimento poderia trazer novas oportunidades para o portfólio, buscando oportunidades com maior margem de crescimento. Nossa I.A irá te apresentar uma possibilidade de rebalanceamento ao final desta análise.

ALERTA MÁXIMO! A avaliação feita pela nossa I.A destaca a criptomoeda  num nível de valorização surpreendente. A partir de uma ampla gama de dados, incluindo análises de mercado, menções sociais e sentimentos, identificamos um forte potencial para a realização de lucros e ajustes estratégicos nas alocações atuais. Esta pode ser uma chance de diversificar o portfólio com ativos de alto crescimento. Fique atento às recomendações de rebalanceamento ao concluir esta análise.

ANÁLISE: A criptomoeda XRP encontra-se estável, segundo nossa inteligência artificial. Ajustes estratégicos nas alocações podem ser benéficos para aproveitar futuras oportunidades de crescimento, baseando-se em projeções de mercado. Explore as sugestões de realocação preparadas pela nossa I.A no encerramento desta análise.


Estas sugestões de ajustes não constitui uma recomendação direta de investimento.
`;

// function addFormattedTextBackup(doc, text) {
//     // Divide o texto em parágrafos
//     const paragraphs = text.split('\n').filter(p => p.length > 0);

//     paragraphs.forEach((paragraph, index) => {
//         // Verifica se é necessário adicionar uma quebra de linha entre parágrafos
//         if (index > 0) {
//             doc.moveDown(2.2); // Move para baixo para criar um espaço entre os parágrafos
//         }

//         const parts = paragraph.split('**');
//         let isBold = false;

//         parts.forEach(part => {
//             // Reinicia o estado contínuo para cada nova parte
//             const options = isBold ? { continued: true, indent: 0 } : { continued: true, indent: 0 };

//             if (isBold) {
//                 // Parte em negrito
//                 doc.font('uploads/fonts/Montserrat-Bold.ttf').text(part, options).fontSize(12).fillColor('black');
//             } else {
//                 // Parte normal
//                 doc.font('uploads/fonts/Montserrat-Regular.ttf').text(part, options).fontSize(12).fillColor('black');
//             }

//             // Alternar entre negrito e normal
//             isBold = !isBold;
//         });

//         // Finaliza o parágrafo atual no PDF
//         doc.text('', { continued: false });
//     });
// }

const PDFDocument = require('pdfkit');
const fs = require('fs');
const path = require('path');

function convertToBase64(doc) {
    return new Promise((resolve, reject) => {
        // Cria um buffer para armazenar o PDF em memória
        const buffers = [];
        doc.on('data', buffers.push.bind(buffers));
        doc.on('end', () => {
            const pdfData = Buffer.concat(buffers);
            const base64 = pdfData.toString('base64');
            resolve(base64);
        });
        // Finaliza o documento e escreve no buffer
        doc.end();

        // Captura erros
        doc.on('error', reject);
    });
}

function savePDF(doc, pdf_path) {
    return new Promise((resolve, reject) => {
        const stream = fs.createWriteStream(pdf_path);
        doc.pipe(stream);
        doc.end();

        stream.on('finish', () => resolve(true));
        stream.on('error', reject);
    });
}

// Função auxiliar para adicionar fundo em cada página
function addPageBackground(doc) {
    const pageWidth = doc.page.width;
    const pageHeight = doc.page.height;

    // Define a cor azul claro. Exemplo: #ADD8E6 ou uma cor RGB equivalente
    const lightBlue = '#ADD8E6';

    // Desenha um retângulo que cobre toda a página com a cor definida
    doc.rect(0, 0, pageWidth, pageHeight).fill("#ffffff");
};

// Função auxiliar para adicionar cabeçalho em cada página
function addHeader(doc, imagePath) {
    const pageWidth = doc.page.width;
    const logoSize = { width: pageWidth, height: 30 };
    const logoX = (pageWidth / 2) - (logoSize.width / 2);
    const logoY = 0;
    doc.image(imagePath, logoX, logoY, { width: logoSize.width });
}

// Função auxiliar para adicionar rodapé em cada página
function addFooter(doc, imagePath) {
    const pageWidth = doc.page.width;
    const pageHeight = doc.page.height;
    const logoSize = { width: pageWidth }; // Ajuste conforme necessário
    const logoX = (pageWidth / 2) - (logoSize.width / 2);
    const logoY = pageHeight - 840; // Ajuste o valor para posicionar conforme desejado

    doc.image(imagePath, logoX, logoY, { width: logoSize.width });
}

// Função para processar e adicionar texto ao documento
function addFormattedText(doc, text) {
    // Divide o texto em parágrafos
    const paragraphs = text.split('\n').filter(p => p.length > 0);

    paragraphs.forEach((paragraph, index) => {
        // Verifica se é necessário adicionar uma quebra de linha entre parágrafos
        if (index > 0) {
            doc.moveDown(2.2); // Move para baixo para criar um espaço entre os parágrafos
        }

        const parts = paragraph.split('**');
        let isBold = false;

        parts.forEach(part => {
            // Verifica se a parte contém um URL
            const urlRegex = /https?:\/\/[^\s]+/g;
            let match;

            // Processa o texto normal ou em negrito, procurando por URLs
            while ((match = urlRegex.exec(part)) !== null) {
                // Texto antes do URL, se houver
                const textBeforeUrl = part.substring(0, match.index);
                if (textBeforeUrl) {
                    doc.font(isBold ? 'uploads/fonts/Montserrat-Bold.ttf' : 'uploads/fonts/Montserrat-Regular.ttf')
                        .fillColor('black')
                        .text(textBeforeUrl, { continued: true });
                }

                // O URL
                doc.font('uploads/fonts/Montserrat-Regular.ttf')
                    .fillColor('blue')
                    .text(match[0], { link: match[0], continued: true, underline: true });

                // Atualiza a posição de início para depois do URL
                part = part.substring(match.index + match[0].length);
                urlRegex.lastIndex = 0; // Reseta o regex para a próxima busca
            }

            // Texto restante após o último URL, ou o texto inteiro se não houver URL
            if (part) {
                doc.font(isBold ? 'uploads/fonts/Montserrat-Bold.ttf' : 'uploads/fonts/Montserrat-Regular.ttf')
                    .fillColor('black')
                    .text(part, { continued: true, underline: false });
            }

            // Alternar entre negrito e normal
            isBold = !isBold;
        });

        // Finaliza o parágrafo atual no PDF
        doc.text('', { continued: false });
    });
}


async function create_pdf(texto) {
    const doc = new PDFDocument({
        size: 'A4',
        margins: { top: 160, bottom: 120, left: 72, right: 72 },
        bufferPages: true,
    });

    // Adiciona a imagem de capa ocupando toda a página
    doc.image("uploads/logos/capa_dicas_cripto_analise.png", 0, 0, { width: doc.page.width, height: doc.page.height });

    // Adiciona uma nova página para o conteúdo seguinte, com margens padrão
    doc.addPage();

    // Define o espaçamento de linha globalmente
    doc.lineGap(2); // Ajuste o valor conforme necessário

    const header_png = 'uploads/logos/header_dicascripto_analise.png';
    const footer_png = "uploads/logos/footer_pdf_analise.png"

    doc.on('pageAdded', () => {
        addPageBackground(doc); // Adiciona o fundo azul claro
        addHeader(doc, header_png);
        addFooter(doc, footer_png);
        doc.font('uploads/fonts/Montserrat-Regular.ttf').fontSize(12).fillColor('black');
    });

    // Incializa tudo
    addPageBackground(doc); // Adiciona o fundo na primeira página antes do cabeçalho
    addHeader(doc, header_png);
    addFooter(doc, footer_png);
    doc.font('uploads/fonts/Montserrat-Regular.ttf').fontSize(12).fillColor('black');

    // Processar e adicionar o texto formatado
    addFormattedText(doc, texto);

    // Adiciona uma nova página para as midias sociais, com margens padrão
    doc.addPage();

    // Adiciona o título centralizado
    doc.font('uploads/fonts/Montserrat-Bold.ttf')
        .fontSize(12)
        .fillColor('black')
        .text("Junte-se à Nossa Comunidade", { underline: false, align: 'center' });

    // Move para baixo após o título para adicionar espaço
    doc.moveDown(1); // Ajusta o valor conforme necessário para mais espaço

    // Define o alinhamento para esquerda para o texto seguinte
    doc.x = 72; // Restaura a posição x para a margem esquerda

    // Agora adiciona o texto das mídias sociais, que será alinhado à esquerda
    addFormattedText(doc, `Comunidade Dicas Cripto [FREE]: https://chat.whatsapp.com/KOMIxcf5hl4F0k6vclI0Kr
Website: https://dicascripto.com
Instagram: https://www.instagram.com/dicascripto
TikTok: https://tiktok.com/@dicascripto
YouTube: https://www.youtube.com/@dicascriptobr`);

    // Salva o arquivo PDF na pasta raiz do projeto e converte para base64
    const pdf_path = path.join(process.cwd(), 'output.pdf');
    return await convertToBase64(doc, pdf_path);
    // return await savePDF(doc, pdf_path);
}

// create_pdf(mensagem_enorme).then((base64_string) => {
//     // console.log(base64_string); // Aqui você tem seu PDF em base64
// }).catch((error) => {
//     console.error("Ocorreu um erro ao criar o PDF:", error);
// });

module.exports = {
    create_pdf
};